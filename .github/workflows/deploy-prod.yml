name: Deploy to production stand

on:
  workflow_dispatch:
    inputs:
      commit:
        description: 'Ð¡heckout specific commit'
        required: false
      deploy-dev:
        description: 'Deploy to dev stand firstly'
        type: boolean
        default: true
      production-check:
        description: 'DEPLOY TO PRODUCTION'
        type: boolean
        default: false
        required: true

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    if: ${{ inputs.production-check }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
   
    - name: Checkout specific commit
      if: ${{ inputs.commit != '' }}
      run:	git checkout ${{ inputs.commit }}

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Cache image
      uses: satackey/action-docker-layer-caching@v0.0.11
      continue-on-error: true

    - name: Build and push prod and dev image
      if: ${{ inputs.deploy-dev }}
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          vzalygin/samowarium:prod
          vzalygin/samowarium:dev

    - name: Build and push prod only image
      if: ${{ !inputs.deploy-dev }}
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: vzalygin/samowarium:prod
    
  deploy-to-dev:
    needs: build-and-push-image
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy-dev }}
    steps:
    - name: Checkout
      uses: actions/checkout@v4
   
    - name: Checkout specific commit
      if: ${{ inputs.commit != '' }}
      run:	git checkout ${{ inputs.commit }}
    
    - name: Prepare configuration
      run: |
        echo ENV=DEV >> .env;
        echo TELEGRAM_TOKEN=${{ secrets.DEV_TG_TOKEN }} >> .env;
        echo VERSION=$(git rev-parse --short HEAD) >> .env;
  
    - name: Configure Docker Host
      uses: khaledez/configure-docker-host@v2
      with:
        host: ${{ secrets.DEV_HOST }}
        user: ${{ secrets.DEV_SSH_USER }}
        ssh-private-key: ${{ secrets.DEV_SSH_KEY }}

    - name: Pull image
      run: |
          docker compose pull samowarium-dev || 
          exit 1

    - name: Reload container
      run: |
          docker compose down samowarium-dev && 
          docker compose up -d samowarium-dev ||
          exit 1

  deploy-to-prod:
    needs: [build-and-push-image, deploy-to-dev]
    if: |
      always() &&
      needs.build-and-push-image.result == 'success' &&
      ( needs.deploy-to-dev.result == 'success' ||
        needs.deploy-to-dev.result == 'skipped' )
    runs-on: ubuntu-latest
    steps:
    - name: Checkoutf
      uses: actions/checkout@v4

    - name: Checkout specific commit
      if: ${{ inputs.commit != '' }}
      run:	git checkout ${{ inputs.commit }}

    - name: Prepare configuration
      run: |
        echo ENV=DEV >> .env;
        echo TELEGRAM_TOKEN=${{ secrets.PROD_TG_TOKEN }} >> .env;
        echo VERSION=$(git rev-parse --short HEAD) >> .env;

    - name: Configure Docker Host
      uses: khaledez/configure-docker-host@v2
      with:
        host: ${{ secrets.PROD_HOST }}
        user: ${{ secrets.PROD_SSH_USER }}
        ssh-private-key: ${{ secrets.PROD_SSH_KEY }}

    - name: Pull image
      run: |
          docker compose pull samowarium-prod || 
          exit 1

    - name: Reload container
      run: |
          docker compose down samowarium-prod && 
          docker compose up -d samowarium-prod ||
          exit 1    
